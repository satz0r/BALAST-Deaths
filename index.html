<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BALAST Guild - Death Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #4ecdc4;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #4ecdc4;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: bold;
            color: #4ecdc4;
        }
        
        select, input {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
        }
        
        select option {
            background: #16213e;
            color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chart-container h3 {
            margin: 0 0 20px 0;
            color: #4ecdc4;
            text-align: center;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4ecdc4;
            max-width: 200px;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis text {
            fill: #ffffff;
        }
        
        .axis path,
        .axis line {
            stroke: #ffffff;
            stroke-width: 1;
        }
        
        .bar {
            transition: opacity 0.3s;
        }
        
        .bar:hover {
            opacity: 0.7;
        }
        
        .admin-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        
        .admin-link:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <a href="admin-interface.html" class="admin-link">⚙️ Admin Panel</a>
    
    <div class="dashboard">
        <div class="header">
            <h1>⚔️ BALAST Guild Death Analytics ⚔️</h1>
            <p>Hardcore WoW Deaths Analysis Dashboard</p>
        </div>
        
        <div id="loading" class="loading">
            Loading death data from database...
        </div>
        
        <div id="error" class="error" style="display: none;">
            Error loading data. Please check your connection and try again.
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="stats-overview" id="stats-overview">
                <!-- Stats will be populated here -->
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>Class Filter:</label>
                    <select id="classFilter">
                        <option value="all">All Classes</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Level Range:</label>
                    <select id="levelFilter">
                        <option value="all">All Levels</option>
                        <option value="1-20">1-20</option>
                        <option value="21-40">21-40</option>
                        <option value="41-59">41-59</option>
                        <option value="60">Level 60</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Location:</label>
                    <select id="locationFilter">
                        <option value="all">All Locations</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Raid Deaths Only:</label>
                    <select id="raidFilter">
                        <option value="all">All Deaths</option>
                        <option value="yes">Raid Deaths Only</option>
                        <option value="no">Non-Raid Deaths</option>
                    </select>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-container">
                    <h3>Deaths by Class</h3>
                    <div id="classChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Deaths by Level Range</h3>
                    <div id="levelChart"></div>
                </div>
                <div class="chart-container full-width">
                    <h3>Death Timeline</h3>
                    <div id="timelineChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Most Dangerous Locations</h3>
                    <div id="locationChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Deadliest Mobs</h3>
                    <div id="mobChart"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Replace with your Supabase credentials (same as admin panel)
        const SUPABASE_URL = 'https://ctqnpltlpkmlvbgdqrzu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0cW5wbHRscGttbHZiZ2Rxcnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTA3MDEsImV4cCI6MjA3MDQ4NjcwMX0.SplNA1N6XDpGXHSRP6ChFHzmeKkaRD7ceye10JZCfNw';
        
        const { createClient } = supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global variables
        let data = [];
        let filteredData = [];
        const tooltip = d3.select("#tooltip");
        
        // Color schemes
        const classColors = {
            "Warrior": "#C79C6E",
            "Paladin": "#F58CBA",
            "Hunter": "#ABD473",
            "Rogue": "#FFF569",
            "Priest": "#FFFFFF",
            "Mage": "#69CCF0",
            "Warlock": "#9482C9",
            "Druid": "#FF7D0A"
        };
        
        const levelRangeColors = {
            "1-20": "#ff6b6b",
            "21-40": "#4ecdc4",
            "41-59": "#45b7d1",
            "60": "#96ceb4"
        };

        // Load data from Supabase
        async function loadData() {
            try {
                const { data: deaths, error } = await sb
                    .from('guild_deaths')
                    .select('*')
                    .order('death_date', { ascending: true });
                
                if (error) throw error;
                
                // Process the data
                data = deaths.map(d => ({
                    ...d,
                    date: new Date(d.death_date),
                    level: d.level || null,
                    class: d.class || null,
                    location: d.zone || null,
                    mob: d.mob || null,
                    isRaid: d.is_raid || false,
                    characterName: d.character_name || 'Unknown'
                }));
                
                filteredData = [...data];
                
                // Hide loading, show dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                // Initialize dashboard
                populateFilters();
                updateStats();
                createCharts();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <h3>Error Loading Data</h3>
                    <p>Could not connect to the database. Please check:</p>
                    <ul style="text-align: left; display: inline-block;">
                        <li>Internet connection</li>
                        <li>Database credentials</li>
                        <li>Database permissions</li>
                    </ul>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Class filter
            const classes = [...new Set(data.filter(d => d.class).map(d => d.class))].sort();
            const classSelect = d3.select("#classFilter");
            classSelect.selectAll("option:not(:first-child)").remove();
            classes.forEach(cls => {
                classSelect.append("option").attr("value", cls).text(cls);
            });

            // Location filter
            const locations = [...new Set(data.filter(d => d.location).map(d => d.location))].sort();
            const locationSelect = d3.select("#locationFilter");
            locationSelect.selectAll("option:not(:first-child)").remove();
            locations.forEach(loc => {
                locationSelect.append("option").attr("value", loc).text(loc);
            });

            // Add event listeners
            d3.select("#classFilter").on("change", updateDashboard);
            d3.select("#levelFilter").on("change", updateDashboard);
            d3.select("#locationFilter").on("change", updateDashboard);
            d3.select("#raidFilter").on("change", updateDashboard);
        }

        // Update dashboard based on filters
        function updateDashboard() {
            applyFilters();
            updateStats();
            updateCharts();
        }

        // Apply current filters
        function applyFilters() {
            const classFilter = d3.select("#classFilter").node().value;
            const levelFilter = d3.select("#levelFilter").node().value;
            const locationFilter = d3.select("#locationFilter").node().value;
            const raidFilter = d3.select("#raidFilter").node().value;

            filteredData = data.filter(d => {
                if (classFilter !== "all" && d.class !== classFilter) return false;
                if (locationFilter !== "all" && d.location !== locationFilter) return false;
                if (raidFilter === "yes" && !d.isRaid) return false;
                if (raidFilter === "no" && d.isRaid) return false;
                
                if (levelFilter !== "all" && d.level) {
                    if (levelFilter === "1-20" && (d.level < 1 || d.level > 20)) return false;
                    if (levelFilter === "21-40" && (d.level < 21 || d.level > 40)) return false;
                    if (levelFilter === "41-59" && (d.level < 41 || d.level > 59)) return false;
                    if (levelFilter === "60" && d.level !== 60) return false;
                }
                
                return true;
            });
        }

        // Update statistics overview
        function updateStats() {
            const totalDeaths = filteredData.length;
            const uniqueCharacters = new Set(filteredData.map(d => d.characterName)).size;
            const raidDeaths = filteredData.filter(d => d.isRaid).length;
            const avgLevel = d3.mean(filteredData.filter(d => d.level), d => d.level);
            const mostDeadlyLocation = d3.rollup(filteredData.filter(d => d.location), v => v.length, d => d.location);
            const topLocation = mostDeadlyLocation.size > 0 ? [...mostDeadlyLocation.entries()].sort((a, b) => b[1] - a[1])[0] : null;

            const statsHtml = `
                <div class="stat-card">
                    <h3>Total Deaths</h3>
                    <div class="value">${totalDeaths}</div>
                </div>
                <div class="stat-card">
                    <h3>Characters Lost</h3>
                    <div class="value">${uniqueCharacters}</div>
                </div>
                <div class="stat-card">
                    <h3>Raid Deaths</h3>
                    <div class="value">${raidDeaths}</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Death Level</h3>
                    <div class="value">${avgLevel ? Math.round(avgLevel) : 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <h3>Deadliest Zone</h3>
                    <div class="value" style="font-size: 1.2em;">${topLocation ? topLocation[0] : 'N/A'}</div>
                </div>
            `;
            d3.select("#stats-overview").html(statsHtml);
        }

        // Create all charts (same functions as before but using live data)
        function createCharts() {
            createClassChart();
            createLevelChart();
            createTimelineChart();
            createLocationChart();
            createMobChart();
        }

        // Update all charts
        function updateCharts() {
            d3.select("#classChart").selectAll("*").remove();
            d3.select("#levelChart").selectAll("*").remove();
            d3.select("#timelineChart").selectAll("*").remove();
            d3.select("#locationChart").selectAll("*").remove();
            d3.select("#mobChart").selectAll("*").remove();
            createCharts();
        }

        // Chart creation functions (keeping same logic but with live data)
        function createClassChart() {
            const margin = {top: 20, right: 20, bottom: 40, left: 40};
            const width = 400 - margin.left - margin.right;
            const height = 300 - margin.bottom - margin.top;

            const classCounts = d3.rollup(filteredData.filter(d => d.class), v => v.length, d => d.class);
            const classData = Array.from(classCounts, ([key, value]) => ({class: key, count: value}))
                .sort((a, b) => b.count - a.count);

            const svg = d3.select("#classChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(classData.map(d => d.class))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(classData, d => d.count)])
                .range([height, 0]);

            g.selectAll(".bar")
                .data(classData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.class))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count))
                .attr("fill", d => classColors[d.class] || "#666")
                .on("mouseover", function(event, d) {
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.class}</strong><br/>Deaths: ${d.count}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-45)");

            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y));
        }

        // [Additional chart functions would follow the same pattern]
        // For brevity, I'll include the basic structure - let me know if you need all chart functions

        function createLevelChart() {
    const margin = {top: 20, right: 20, bottom: 40, left: 40};
    const width = 400 - margin.left - margin.right;
    const height = 300 - margin.bottom - margin.top;

    const levelData = filteredData.filter(d => d.level);
    const ranges = [
        {range: "1-20", count: levelData.filter(d => d.level >= 1 && d.level <= 20).length},
        {range: "21-40", count: levelData.filter(d => d.level >= 21 && d.level <= 40).length},
        {range: "41-59", count: levelData.filter(d => d.level >= 41 && d.level <= 59).length},
        {range: "60", count: levelData.filter(d => d.level === 60).length}
    ];

    const svg = d3.select("#levelChart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand().domain(ranges.map(d => d.range))
        .range([0, width]).padding(0.1);
    const y = d3.scaleLinear().domain([0, d3.max(ranges, d => d.count) || 1])
        .range([height, 0]);

    g.selectAll(".bar")
        .data(ranges)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.range))
        .attr("width", x.bandwidth())
        .attr("y", d => y(d.count))
        .attr("height", d => height - y(d.count))
        .attr("fill", d => levelRangeColors[d.range])
        .on("mouseover", (event, d) => {
            tooltip.style("opacity", 1)
                .html(`<strong>${d.range}</strong><br/>Deaths: ${d.count}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    g.append("g").attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));
    g.append("g").attr("class", "axis").call(d3.axisLeft(y));
}

function createTimelineChart() {
    const margin = {top: 20, right: 20, bottom: 60, left: 40};
    const width = 800 - margin.left - margin.right;
    const height = 300 - margin.bottom - margin.top;

    const timeData = d3.rollup(filteredData, v => v.length, d => d3.timeMonth(d.date));
    const timeArray = Array.from(timeData, ([date, count]) => ({date, count}))
        .sort((a, b) => a.date - b.date);

    const svg = d3.select("#timelineChart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    const g = svg.append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleTime()
        .domain(d3.extent(timeArray, d => d.date))
        .range([0, width]);
    const y = d3.scaleLinear()
        .domain([0, d3.max(timeArray, d => d.count) || 1])
        .range([height, 0]);

    const line = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.count))
        .curve(d3.curveMonotoneX);

    g.append("path")
        .datum(timeArray)
        .attr("fill", "none")
        .attr("stroke", "#4ecdc4")
        .attr("stroke-width", 3)
        .attr("d", line);

    g.selectAll(".dot")
        .data(timeArray)
        .enter().append("circle")
        .attr("class", "dot")
        .attr("cx", d => x(d.date))
        .attr("cy", d => y(d.count))
        .attr("r", 5)
        .attr("fill", "#ff6b6b")
        .on("mouseover", (event, d) => {
            tooltip.style("opacity", 1)
                .html(`<strong>${d3.timeFormat("%B %Y")(d.date)}</strong><br/>Deaths: ${d.count}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    g.append("g").attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %Y")))
        .selectAll("text").style("text-anchor", "end")
        .attr("dx", "-.8em").attr("dy", ".15em")
        .attr("transform", "rotate(-45)");
    g.append("g").attr("class", "axis").call(d3.axisLeft(y));
}

function createLocationChart() {
    const margin = {top: 20, right: 20, bottom: 80, left: 40};
    const width = 400 - margin.left - margin.right;
    const height = 300 - margin.bottom - margin.top;

    const locationCounts = d3.rollup(filteredData.filter(d => d.location), v => v.length, d => d.location);
    const locationData = Array.from(locationCounts, ([loc, count]) => ({loc, count}))
        .sort((a, b) => b.count - a.count).slice(0, 10);

    const svg = d3.select("#locationChart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand().domain(locationData.map(d => d.loc))
        .range([0, width]).padding(0.1);
    const y = d3.scaleLinear().domain([0, d3.max(locationData, d => d.count) || 1])
        .range([height, 0]);

    g.selectAll(".bar")
        .data(locationData)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.loc))
        .attr("width", x.bandwidth())
        .attr("y", d => y(d.count))
        .attr("height", d => height - y(d.count))
        .attr("fill", "#45b7d1")
        .on("mouseover", (event, d) => {
            tooltip.style("opacity", 1)
                .html(`<strong>${d.loc}</strong><br/>Deaths: ${d.count}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    g.append("g").attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text").style("text-anchor", "end")
        .attr("dx", "-.8em").attr("dy", ".15em")
        .attr("transform", "rotate(-45)");
    g.append("g").attr("class", "axis").call(d3.axisLeft(y));
}

function createMobChart() {
    const margin = {top: 20, right: 20, bottom: 80, left: 40};
    const width = 400 - margin.left - margin.right;
    const height = 300 - margin.bottom - margin.top;

    const mobCounts = d3.rollup(filteredData.filter(d => d.mob), v => v.length, d => d.mob);
    const mobData = Array.from(mobCounts, ([mob, count]) => ({mob, count}))
        .sort((a, b) => b.count - a.count).slice(0, 10);

    const svg = d3.select("#mobChart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom);

    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand().domain(mobData.map(d => d.mob))
        .range([0, width]).padding(0.1);
    const y = d3.scaleLinear().domain([0, d3.max(mobData, d => d.count) || 1])
        .range([height, 0]);

    g.selectAll(".bar")
        .data(mobData)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.mob))
        .attr("width", x.bandwidth())
        .attr("y", d => y(d.count))
        .attr("height", d => height - y(d.count))
        .attr("fill", "#ff6b6b")
        .on("mouseover", (event, d) => {
            tooltip.style("opacity", 1)
                .html(`<strong>${d.mob}</strong><br/>Kills: ${d.count}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    g.append("g").attr("class", "axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text").style("text-anchor", "end")
        .attr("dx", "-.8em").attr("dy", ".15em")
        .attr("transform", "rotate(-45)");
    g.append("g").attr("class", "axis").call(d3.axisLeft(y));
}

// Initialize
document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
